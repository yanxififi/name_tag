#include <WiFi.h>
#include <WebServer.h>
#include <esp_now.h>
#include <esp_wifi.h>
#include <esp_err.h>

// ===== Config =====
static const int ESPNOW_CHANNEL = 1;
const char* AP_SSID = "TAG_REMOTE";
const char* AP_PASS = "12345678";

WebServer server(80);

// ---- Replace with your tag MAC addresses (from tag Serial Monitor) ----
// Format: {0xAA,0xBB,0xCC,0xDD,0xEE,0xFF}
uint8_t TAG1_MAC[] = {0xAA,0xBB,0xCC,0xDD,0xEE,0xFF};
uint8_t TAG2_MAC[] = {0x11,0x22,0x33,0x44,0x55,0x66};
// ----------------------------------------------------------------------

typedef struct __attribute__((packed)) {
  uint8_t cmd;   // 0=setPattern
  uint8_t value; // 0..4
} Msg;

String macToString(const uint8_t* mac) {
  char buf[18];
  snprintf(buf, sizeof(buf), "%02X:%02X:%02X:%02X:%02X:%02X",
           mac[0], mac[1], mac[2], mac[3], mac[4], mac[5]);
  return String(buf);
}

bool addPeer(const uint8_t* mac) {
  esp_now_peer_info_t peer = {};
  memcpy(peer.peer_addr, mac, 6);
  peer.channel = ESPNOW_CHANNEL;
  peer.encrypt = false;

  // IMPORTANT on S3: choose interface. For AP+STA mode, STA is usually safest for ESP-NOW.
  peer.ifidx = WIFI_IF_STA;

  esp_err_t r = esp_now_add_peer(&peer);
  if (r == ESP_OK || r == ESP_ERR_ESPNOW_EXIST) return true;
  Serial.printf("add_peer %s failed: %s (%d)\n", macToString(mac).c_str(), esp_err_to_name(r), (int)r);
  return false;
}

void sendToOne(const uint8_t* mac, uint8_t p) {
  Msg m{0, p};
  esp_err_t r = esp_now_send(mac, (uint8_t*)&m, sizeof(m));
  Serial.printf("Send to %s pattern %d -> %s (%d)\n",
                macToString(mac).c_str(), p, esp_err_to_name(r), (int)r);
}

void sendToBoth(uint8_t p) {
  sendToOne(TAG1_MAC, p);
  sendToOne(TAG2_MAC, p);
}

const char INDEX_HTML[] PROGMEM = R"HTML(
<!doctype html><html><head>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Name Tag Remote</title>
<style>
body{font-family:Arial;padding:18px}
button{padding:14px 16px;margin:8px 10px 0 0;font-size:16px}
#log{background:#f4f4f4;padding:10px;border-radius:10px;min-height:70px;white-space:pre-wrap}
</style></head><body>
<h2>Name Tag Remote</h2>
<p>Send to both tags:</p>
<button onclick="setC(0)">0 OFF</button>
<button onclick="setC(1)">1</button>
<button onclick="setC(2)">2</button>
<button onclick="setC(3)">3</button>
<button onclick="setC(4)">4</button>
<div id="log"></div>
<script>
async function setC(c){
  try{
    const r=await fetch('/set?c='+c);
    document.getElementById('log').textContent=await r.text();
  }catch(e){
    document.getElementById('log').textContent='ERROR: '+e;
  }
}
</script></body></html>
)HTML";

void handleRoot() { server.send(200, "text/html", INDEX_HTML); }

void handleSet() {
  if (!server.hasArg("c")) { server.send(400, "text/plain", "Missing ?c=0..4"); return; }
  int c = server.arg("c").toInt();
  if (c < 0 || c > 4) { server.send(400, "text/plain", "c must be 0..4"); return; }
  sendToBoth((uint8_t)c);
  server.send(200, "text/plain", "Sent to both tags: c=" + String(c));
}

void setup() {
  Serial.begin(115200);
  delay(200);
  Serial.println("\n=== Controller (AP + Web + ESP-NOW Unicast) ===");

  // Enable BOTH AP and STA (fixes many ESP-NOW send errors on S3)
  WiFi.mode(WIFI_AP_STA);

  // Start AP on fixed channel
  bool ok = WiFi.softAP(AP_SSID, AP_PASS, ESPNOW_CHANNEL);
  if (!ok) {
    Serial.println("❌ Failed to start AP");
    while (true) delay(1000);
  }
  Serial.print("AP IP: "); Serial.println(WiFi.softAPIP());
  Serial.print("AP MAC: "); Serial.println(WiFi.softAPmacAddress());
  Serial.println("Open: http://192.168.4.1");

  // Force channel (extra safety)
  esp_wifi_set_promiscuous(true);
  esp_wifi_set_channel(ESPNOW_CHANNEL, WIFI_SECOND_CHAN_NONE);
  esp_wifi_set_promiscuous(false);

  if (esp_now_init() != ESP_OK) {
    Serial.println("❌ esp_now_init failed");
    while (true) delay(1000);
  }
  Serial.println("✅ ESP-NOW init ok");

  // Add both tag peers
  Serial.println("Adding peers...");
  addPeer(TAG1_MAC);
  addPeer(TAG2_MAC);
  Serial.println("✅ Peers added");

  server.on("/", handleRoot);
  server.on("/set", handleSet);
  server.begin();
  Serial.println("✅ Web server started");
}

void loop() { server.handleClient(); }
